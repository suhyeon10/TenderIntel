# 성능 테스트 가이드

RAG 시스템의 성능을 측정하고 병목 지점을 파악하는 테스트 스크립트입니다.

## 실행 방법

```bash
cd backend
python scripts/performance_test.py
```

또는 가상환경에서:

```bash
cd backend
venv\Scripts\activate  # Windows
# 또는
source venv/bin/activate  # Linux/Mac

python scripts/performance_test.py
```

## 측정 항목

### 1. 단일 임베딩 생성 성능
- 단일 텍스트의 임베딩 생성 시간 측정
- 반복 측정으로 평균/중앙값/표준편차 계산

### 2. 배치 임베딩 생성 성능
- 여러 텍스트를 한 번에 처리할 때의 성능
- 배치 크기별 성능 비교 (1, 5, 10, 20개)
- 배치 처리의 효율성 확인

### 3. 임베딩 캐시 효과
- 캐시 없이 생성 vs 캐시 있음 (재사용)
- 캐시 히트율 및 속도 향상 측정

### 4. 벡터 검색 성능
- Supabase pgvector 검색 속도
- top_k 결과 개수별 성능

### 5. LLM 응답 생성 성능
- Ollama LLM 응답 생성 시간
- 프롬프트 처리 및 생성 속도

### 6. Dual RAG 검색 성능
- 계약서 청크 검색 + 법령 청크 검색 병렬 처리
- 비동기 병렬 처리 효과 확인

### 7. 전체 계약서 분석 파이프라인
- 텍스트 추출 → 청킹 → 임베딩 → RAG 검색 → LLM 분석
- 각 단계별 소요 시간 측정
- 전체 파이프라인 시간 측정

### 8. 비동기 병렬 처리 효과
- 순차 실행 vs 병렬 실행 비교
- 속도 향상 배수 계산

## 결과 해석

### 성능 지표
- **평균**: 여러 측정의 평균값
- **중앙값**: 중간값 (이상치 영향 적음)
- **최소/최대**: 최고/최악 성능
- **표준편차**: 측정값의 분산 정도

### 최적화 권장사항
스크립트는 자동으로 다음을 분석합니다:
- 배치 임베딩 사용 시 속도 향상
- 캐시 사용 시 속도 향상
- 병렬 처리 효과

## 예상 결과

### 일반적인 성능 (참고)
- **단일 임베딩**: 0.1~0.5초 (CPU), 0.05~0.2초 (GPU)
- **배치 임베딩 (10개)**: 0.5~2초 (CPU), 0.2~1초 (GPU)
- **벡터 검색**: 0.1~0.3초
- **LLM 응답**: 2~10초 (모델 및 프롬프트 길이에 따라)
- **전체 파이프라인**: 5~20초

### 성능 개선 팁
1. **배치 임베딩 사용**: 여러 텍스트를 한 번에 처리
2. **캐시 활용**: 동일한 쿼리 재사용 시 캐시 사용
3. **병렬 처리**: 독립적인 작업은 `asyncio.gather`로 병렬 실행
4. **GPU 사용**: GPU가 있으면 임베딩 생성 속도 향상

## 문제 해결

### 임베딩 생성 실패
- `sentence-transformers` 설치 확인
- 모델 다운로드 확인 (`BAAI/bge-m3`)

### LLM 연결 실패
- Ollama 서버 실행 확인: `ollama serve`
- 모델 설치 확인: `ollama list`

### 벡터 검색 실패
- Supabase 연결 확인
- `legal_chunks` 테이블 데이터 확인

## 커스터마이징

스크립트를 수정하여 다음을 변경할 수 있습니다:
- 반복 횟수 조정
- 테스트 텍스트 변경
- 배치 크기 조정
- 추가 성능 지표 측정

## 예시 출력

```
🚀 RAG 시스템 성능 테스트 시작
   임베딩 모델: BAAI/bge-m3
   LLM 모델: mistral
   벡터 DB: Supabase

============================================================
  1. 단일 임베딩 생성 성능
============================================================
   [1/10] 0.234초 - '근로계약서의 수습 기간은 최대 3개월...'
   [2/10] 0.198초 - '임금은 매월 말일에 지급하며...'
   ...

📊 단일 임베딩 생성
   평균: 0.215 초
   중앙값: 0.210 초
   최소: 0.185 초
   최대: 0.250 초
   표준편차: 0.020 초
   측정 횟수: 10회
```

